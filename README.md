# TornHub
A Python tool for accessing the Torn API and caching data.

# You will need

```Python3```
Run the setup.sh bash script. This will try to set up an environment and install the dependancies and supporting apps.  Read this and choose before you start - you may prefor to safely install each manually.

## Run setup.sh

### Mac & Linux (uses APT-Get)

```sh
chmod +x setup_dependencies.sh
./setup.sh
```

# Dependancies

```
pip install requests
pip install tabulate
pip install eralchemy graphviz
```


## venv (Optional)

```python3 -m venv .venv```

```source .venv/bin/activate```  # On macOS/Linux

```.venv\Scripts\activate``` # On Windows

## db browser UI (Optional)

```brew install db-browser-for-sqlite```

## visualiser for eralchemy (Optional)

```brew install graphviz```

# DB folder for theÂ Database 

A SQLite database that can be opened with tools such as DB Browser for SQLite. The schema schema dump and diagram are generated by ```python3 generateSchema.py```
```
.\db\data\torn_data.db
.\db\data\schema_diagram.png 
.\db\data\schema_dump.txt 
```

![The schema diagram will apppear here after generateSchema.py has been run](data/db/schema_diagram.png) 

# Cache folder

This folder contains the JSON retrieved from Torn. Paged data will be combined into one file and topped up each time.

# Writing a script

See ```demo.py```

```python
import sqlite3 # db engine
from Torn.manageDB import initDB,DB_CONNECTPATH
from Torn.updateDB import updateDB
from tabulate import tabulate # optional support for outputing tables as text grids or HTML
```

```python
# Optional - you need to to these at least once but can run on stale data without them
initDB() # creates the database if not already done 
updateDB() # updates the Torn data using the API
```

Open a connection to the DB and get a cursor to use on it. Remember to commit the changes and close the connection or you can lose data and corrupt the DB file. 

```python
conn = sqlite3.connect(DB_CONNECTPATH)
cursor = conn.cursor()

# ... run your code ... 

comm.commit # Commit changes if make any
conn.close # Close the connection
```

Execute a command:
```Python
cursor.execute('''PRAGMA integrity_check;''')
```
Print all the results (cursor.fetchall()) in a simple layout with headers
```Python
# get the data for all rows
results = cursor.fetchall()
# read the column descriptions to use as the table heads in the top row
tableHeaders = [desc[0] for desc in cursor.description]
# generate a simple text table in a string
table =tabulate(results, headers=tableHeaders, tablefmt="simple")
# print it, or save it
print(table)
```
### Result
The integrity_check pragma returns one row containing its OK result (or raises an error)
```text
integrity_check
-----------------
ok
```

A simple query is easy.  You should test your SQL in the db browser program first.

```Python
# run a simple query
# this SELECTS some columns 
# FROM the sqlite_master table 
# but only WHERE a row matches the test and name does not begin with an underscore
# sort the results in order by column 1 then colum 2
cursor.execute('''
    SELECT type, name 
    FROM sqlite_master 
    WHERE name NOT LIKE '[_]%' 
    ORDER BY 1, 2
''')
# print the results in a grid
print(tabulate(cursor.fetchall(), headers= [desc[0] for desc in cursor.description], tablefmt="grid"))
```
### Result
```text
+--------+--------------------------------+
| type   | name                           |
+========+================================+
| index  | sqlite_autoindex_crime_names_1 |
+--------+--------------------------------+
| index  | sqlite_autoindex_preferences_1 |
+--------+--------------------------------+
| table  | crime_names                    |
+--------+--------------------------------+
| table  | crime_positions                |
+--------+--------------------------------+
| table  | crime_slots                    |
+--------+--------------------------------+
| table  | crimes                         |
+--------+--------------------------------+
| table  | faction_members                |
+--------+--------------------------------+
| table  | preferences                    |
+--------+--------------------------------+
| table  | slot_assignments               |
+--------+--------------------------------+
| table  | sqlite_sequence                |
+--------+--------------------------------+
| table  | users                          |
+--------+--------------------------------+
| view   | _rowCounts                     |
+--------+--------------------------------+
| view   | crime_name_positions_view      |
+--------+--------------------------------+
| view   | crime_slot_assignments_view    |
+--------+--------------------------------+
| view   | faction_members_view           |
+--------+--------------------------------+
```
Close gracefully
```Python
# Commit changes if make any
comm.commit 
# Close the connection
conn.close
```
